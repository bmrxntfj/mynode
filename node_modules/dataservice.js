var extsions=require('extsion');
var log=require('log');

exports.run=function(context){
	try{
		invokeMethod(context);
	}
	catch(e){
		log.error(e);
		context.response.write(JSON.stringify({success:false,errors:e}));
		context.response.end();
	}
}

function invokeMethod(context){

	var arr=context.params.pathname.split('/');
	var mName=arr[arr.length-1];
	var dsName=arr[arr.length-2];
	var ds=require('../server/'+dsName+'.js');
	var method=ds[mName];
	if(!method){context.response.write(mName+" method can't find!");return;}
	var defineParams=extsions.getDefineParams(method);
	var methodParams=[];
	extsions.each(defineParams,function(dp){
		if(dp=='callback'){return;}
		methodParams.push(context.params.query[dp]);
	});
	methodParams.push(function(result){
		if(result===undefined||result==null){result={};}
		if(result.success===undefined){result.success=true;}
		var d=JSON.stringify(result);
		log.info(d);
		if(result){context.response.write(d);}
		context.response.end();
	});
	method.apply(context,methodParams);
}

