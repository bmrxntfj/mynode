var http = require('http');
var util = require('util');
var url = require('url');
var querystring=require('querystring');
var extsion=require('extsion');

exports.run = function (routes) {
    http.createServer(function (req, res) {
        var context = { request: req, response: res };
        var queryparams = url.parse(req.url);
        switch (req.method.toLowerCase()) {
            case 'get': 
                {
                    context.params = queryparams;
                    handle(context, routes);
                    break;
                }
            case 'post': 
                {
                    if (req.headers['content-type'] == 'application/x-www-form-urlencoded') {
                        var postdata = '';
                        req.on('data', function (chunk) {
                            postdata += chunk;
                        });
                        req.on('end', function () {
                            var postparmas = querystring.parse(postdata);
                            for (var p in postparmas) { postparmas[p] = eval(postparmas[p]); }
                            context.params = extsion.apply(queryparams, postparmas);
                            handle(context, routes);
                        });
                    }
                    else {
                        handle(context, routes);
                    }
                    break;
                }
        }

    }).listen(1337, '127.0.0.1');
    console.log('Server running at http://127.0.0.1:1337/');
}

function handle(context, routes) {
	extsion.each(routes,function(route){
		if(route.pattern.test(context.params.pathname.toLowerCase())){
			route.handle.run(context);
			return false;
		}
	});
}
